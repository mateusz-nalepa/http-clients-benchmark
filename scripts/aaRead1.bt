#define TARGET_PID 28462


kprobe:__x64_sys_recvfrom
/ pid == TARGET_PID /
{
    @start[tid] = nsecs;
    @proc_name[tid] = comm;
    @fd[tid] = arg0;
    @buf[tid] = arg1;
}


kretprobe:__x64_sys_recvfrom
/ @start[tid] / //&& retval > 0 /
{
    $duration = nsecs - @start[tid];

        if (@proc_name[tid] != "reactor-http-ep") {
            //printf("{\"RECVFROMthread\": \"%s\", \"recv_duration_ns\": %lld, \"fd\": %d, \"bytes_received\": %d}\n", @proc_name[tid], $duration, @fd[tid], retval);
        }

    delete(@start[tid]);
    delete(@fd[tid]);
    delete(@buf[tid]);
}

tracepoint:syscalls:sys_enter_epoll_wait
/ pid == TARGET_PID /
{
    @start[tid] = nsecs;
    @proc_name[tid] = comm;
    @xdTimeout[tid] = args->timeout;
    @xdMaxEvents[tid] = args->maxevents;
}

tracepoint:syscalls:sys_exit_epoll_wait
/ @start[tid] && pid == TARGET_PID /
{
    $duration = nsecs - @start[tid];
    $retval = args->ret;
    if ($retval != 0 && $retval != 1 && @proc_name[tid] != "reactor-http-ep") {
        //printf("{ \"EEEEEEEEEEEPOLL_WAIT_pid\": %d, \"process\": \"%s\", \"event\": \"epoll_wait\", \"maxEvents\": \"%d\", \"timeout\": \"%d\", \"result\": \"%d\", \"duration_ns\": %lld }\n", pid, @proc_name[tid], @xdMaxEvents[tid],  @xdTimeout[tid], $retval, $duration);
    }
    delete(@start[tid]);
    delete(@proc_name[tid]);
    delete(@xdTimeout[tid]);
    delete(@xdMaxEvents[tid]);
}


kprobe:mutex_lock
/ pid == TARGET_PID /
{
    @start[tid] = nsecs;
        @proc_name[tid] = comm;

}

kprobe:mutex_unlock
/ @start[tid] /
{
    $duration = nsecs - @start[tid];
    printf("PROCNAME: %s, mutex locked for %lld ns\n", @proc_name[tid], $duration);
    delete(@start[tid]);
    delete(@proc_name[tid]);
}
